#!/usr/bin/env bash

# å¼•æ•°ã®å‡¦ç†
if [ "$1" == "weekly" ]; then
  # é€±æ¬¡ãƒ¢ãƒ¼ãƒ‰
  MODE="weekly"
  
  # ä»Šé€±ã®æœˆæ›œæ—¥ã‚’è¨ˆç®—
  # %u: 1 (Mon) .. 7 (Sun)
  dow=$(date +%u)
  monday_offset=$((dow-1))
  this_monday=$(date -d "-$monday_offset days" +%Y-%m-%d)
  
  # ç¬¬2å¼•æ•°ã§ã‚ªãƒ•ã‚»ãƒƒãƒˆæŒ‡å®š (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 0)
  # weekly -1 => å…ˆé€±
  week_offset=${2:-0}
  diff_days=$((week_offset * 7))
  
  REPORT_DATE=$(date -d "$this_monday $diff_days days" +%Y-%m-%d)
  NEXT_DATE=$(date -d "$REPORT_DATE + 7 days" +%Y-%m-%d)
  
  # ç¯„å›²: æœˆæ›œ 04:00 ã€œ ç¿Œæœˆæ›œ 04:00
  FROM="${REPORT_DATE}T04:00:00+09:00"
  TO="${NEXT_DATE}T04:00:00+09:00"

elif [ "$1" == "monthly" ]; then
  # æœˆæ¬¡ãƒ¢ãƒ¼ãƒ‰
  MODE="monthly"

  # ä»Šæœˆã®1æ—¥ã‚’è¨ˆç®—
  this_month_start=$(date +%Y-%m-01)
  
  # ç¬¬2å¼•æ•°ã§ã‚ªãƒ•ã‚»ãƒƒãƒˆæŒ‡å®š (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 0)
  # monthly -1 => å…ˆæœˆ
  month_offset=${2:-0}
  
  REPORT_DATE=$(date -d "$this_month_start $month_offset month" +%Y-%m-%d)
  NEXT_DATE=$(date -d "$REPORT_DATE + 1 month" +%Y-%m-%d)
  
  # ç¯„å›²: 1æ—¥ 04:00 ã€œ ç¿Œæœˆ1æ—¥ 04:00
  FROM="${REPORT_DATE}T04:00:00+09:00"
  TO="${NEXT_DATE}T04:00:00+09:00"
elif [ -z "$1" ]; then
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ä»Šæ—¥ (Yesterday 04:00 ~ Today 04:00 context usually, or simply T04:00 based logic below)
  # å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯: REPORT_DATE="now" -> date -d "now - 4 hours"
  MODE="daily"
  TARGET_DATE_STR="now"
elif [[ "$1" =~ ^-?[0-9]+$ ]]; then
  # æ•°å€¤æŒ‡å®š: æ—¥ä»˜ã‚ªãƒ•ã‚»ãƒƒãƒˆ (Daily)
  MODE="daily"
  TARGET_DATE_STR="$1 day"
else
  # ãã®ä»–æ—¥ä»˜æŒ‡å®šãªã©
  MODE="daily"
  TARGET_DATE_STR="$1"
fi

# æ—¥ä»˜è¨ˆç®— (Dailyãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿å†è¨ˆç®—ãŒå¿…è¦ã€Weeklyã¯ã™ã§ã«FROM/TOè¨­å®šæ¸ˆã¿)
if [ "$MODE" == "daily" ]; then
  REPORT_DATE=$(date -d "$TARGET_DATE_STR - 4 hours" +%Y-%m-%d)
  NEXT_DATE=$(date -d "$REPORT_DATE + 1 day" +%Y-%m-%d)

  # å³å¯†ãªã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½œæˆ (04:00 JST åŒºåˆ‡ã‚Š)
  FROM="${REPORT_DATE}T04:00:00+09:00"
  TO="${NEXT_DATE}T04:00:00+09:00"
fi

echo "Target Date: $REPORT_DATE (Range: $FROM ~ $TO)"

# ---------------------------------------------------------
# 1. ã‚³ãƒŸãƒƒãƒˆã®å–å¾— (gh search commits ã‚’ä½¿ç”¨)
# ---------------------------------------------------------
echo "Fetching commits..."
COMMIT_DATA=$(gh search commits --author "@me" --committer-date "$FROM..$TO" --limit 1000 --json repository --jq '
  [.[] | .repository.name] 
  | group_by(.) 
  | map({name: .[0], count: length}) 
  | sort_by(-.count)
')

TOTAL_COMMITS=$(echo "$COMMIT_DATA" | jq '[.[] | .count] | add // 0')
COMMIT_LIST=$(echo "$COMMIT_DATA" | jq -r '.[] | "- \(.name): \(.count) commits"')

# ---------------------------------------------------------
# 2. Issueã¨PRã®å–å¾— (GraphQLã‚’ä½¿ç”¨)
# ---------------------------------------------------------
echo "Fetching issues & PRs..."
GRAPHQL_DATA=$(gh api graphql -f from="$FROM" -f to="$TO" -f query='
  query($from: DateTime!, $to: DateTime!) {
    viewer{
      calendar: contributionsCollection(from: $from, to: $to) {
        issueContributions(first: 10) {
          nodes {
            issue {
              title
              url
              number
              repository { nameWithOwner }
            }
          }
        }
        pullRequestContributions(first: 10) {
          nodes {
            pullRequest {
              title
              url
              number
              repository { nameWithOwner }
            }
          }
        }
      }
    }
  }
' --jq '.')

# ---------------------------------------------------------
# 3. å‡ºåŠ›
# ---------------------------------------------------------
echo ""
echo "startedAt: $FROM"
echo "endedAt: $TO"
echo ""
echo "### ğŸ“Š Total Contributions: $TOTAL_COMMITS"
echo ""
echo "### ğŸ’» Commits by Repository"
if [ -z "$COMMIT_LIST" ]; then
  echo "No commits found."
else
  echo "$COMMIT_LIST"
fi

echo ""
echo "### ğŸ› Issues Created"
# å¤‰æ›´ç‚¹: [] ã®ä¸­ã« (repo#num) ã‚’å…¥ã‚Œã¾ã—ãŸ
echo "$GRAPHQL_DATA" | jq -r '
  .data.viewer.calendar.issueContributions.nodes[] | 
  "- [\(.issue.title) (\(.issue.repository.nameWithOwner)#\(.issue.number))](\(.issue.url))"
'

echo ""
echo "### ğŸ”€ Pull Requests Created"
# å¤‰æ›´ç‚¹: [] ã®ä¸­ã« (repo#num) ã‚’å…¥ã‚Œã¾ã—ãŸ
echo "$GRAPHQL_DATA" | jq -r '
  .data.viewer.calendar.pullRequestContributions.nodes[] | 
  "- [\(.pullRequest.title) (\(.pullRequest.repository.nameWithOwner)#\(.pullRequest.number))](\(.pullRequest.url))"
'
