#!/usr/bin/env bash
set -euo pipefail

# =========================================
# å®šæ•°
# =========================================
readonly TZ_OFFSET="+09:00"
readonly DAY_START_HOUR="04:00:00"

# =========================================
# ãƒ˜ãƒ«ãƒ—
# =========================================
show_help() {
  cat << EOF
Usage: gh-activity [MODE] [OFFSET]

Modes:
  daily   [N]   æ—¥æ¬¡ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)  N=-1 ã§æ˜¨æ—¥
  weekly  [N]   é€±æ¬¡              N=-1 ã§å…ˆé€±
  monthly [N]   æœˆæ¬¡              N=-1 ã§å…ˆæœˆ

Examples:
  gh-activity              ä»Šæ—¥ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
  gh-activity daily -1     æ˜¨æ—¥ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
  gh-activity weekly       ä»Šé€±ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
  gh-activity weekly -1    å…ˆé€±ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
  gh-activity monthly      ä»Šæœˆã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£
EOF
}

# =========================================
# æ—¥ä»˜ç¯„å›²è¨ˆç®—
# =========================================
calc_daily_range() {
  local offset=${1:-0}
  local base_date next_date
  base_date=$(date -d "$offset day - 4 hours" +%Y-%m-%d)
  next_date=$(date -d "$base_date + 1 day" +%Y-%m-%d)
  echo "$base_date" "$next_date"
}

calc_weekly_range() {
  local offset=${1:-0}
  local dow monday diff_days base_date next_date
  dow=$(date +%u)
  monday=$(date -d "-$((dow - 1)) days" +%Y-%m-%d)
  diff_days=$((offset * 7))
  base_date=$(date -d "$monday $diff_days days" +%Y-%m-%d)
  next_date=$(date -d "$base_date + 7 days" +%Y-%m-%d)
  echo "$base_date" "$next_date"
}

calc_monthly_range() {
  local offset=${1:-0}
  local this_month base_date next_date
  this_month=$(date +%Y-%m-01)
  base_date=$(date -d "$this_month $offset month" +%Y-%m-%d)
  next_date=$(date -d "$base_date + 1 month" +%Y-%m-%d)
  echo "$base_date" "$next_date"
}

# =========================================
# ãƒ‡ãƒ¼ã‚¿å–å¾—
# =========================================
fetch_commits() {
  local from=$1 to=$2
  gh search commits --author "@me" --committer-date "$from..$to" --limit 1000 --json repository --jq '
    [.[] | .repository.name]
    | group_by(.)
    | map({name: .[0], count: length})
    | sort_by(-.count)
  '
}

fetch_contributions() {
  local from=$1 to=$2
  gh api graphql -f from="$from" -f to="$to" -f query='
    query($from: DateTime!, $to: DateTime!) {
      viewer {
        calendar: contributionsCollection(from: $from, to: $to) {
          issueContributions(first: 10) {
            nodes { issue { title url number repository { nameWithOwner } } }
          }
          pullRequestContributions(first: 10) {
            nodes { pullRequest { title url number repository { nameWithOwner } } }
          }
        }
      }
    }
  '
}

# =========================================
# å‡ºåŠ›
# =========================================
print_report() {
  local from=$1 to=$2 commit_data=$3 graphql_data=$4

  local total_commits commit_list
  total_commits=$(echo "$commit_data" | jq '[.[] | .count] | add // 0')
  commit_list=$(echo "$commit_data" | jq -r '.[] | "- \(.name): \(.count) commits"')

  echo ""
  echo "Period: $from ~ $to"
  echo ""
  echo "### ðŸ“Š Total Commits: $total_commits"
  echo ""
  echo "### ðŸ’» Commits by Repository"
  echo "${commit_list:-No commits found.}"
  echo ""
  echo "### ðŸ› Issues Created"
  echo "$graphql_data" | jq -r '
    .data.viewer.calendar.issueContributions.nodes // [] | .[] |
    "- [\(.issue.title) (\(.issue.repository.nameWithOwner)#\(.issue.number))](\(.issue.url))"
  ' | grep . || echo "No issues found."
  echo ""
  echo "### ðŸ”€ Pull Requests Created"
  echo "$graphql_data" | jq -r '
    .data.viewer.calendar.pullRequestContributions.nodes // [] | .[] |
    "- [\(.pullRequest.title) (\(.pullRequest.repository.nameWithOwner)#\(.pullRequest.number))](\(.pullRequest.url))"
  ' | grep . || echo "No PRs found."
}

# =========================================
# ãƒ¡ã‚¤ãƒ³
# =========================================
main() {
  local mode="daily"
  local offset=0

  # å¼•æ•°ãƒ‘ãƒ¼ã‚¹
  case "${1:-}" in
    -h|--help) show_help; exit 0 ;;
    daily)     mode="daily";   offset=${2:-0} ;;
    weekly)    mode="weekly";  offset=${2:-0} ;;
    monthly)   mode="monthly"; offset=${2:-0} ;;
    "")        mode="daily";   offset=0 ;;
    *)         mode="daily";   offset=${1:-0} ;;
  esac

  # æ—¥ä»˜ç¯„å›²è¨ˆç®—
  local base_date next_date
  read -r base_date next_date <<< "$(calc_${mode}_range "$offset")"

  local from="${base_date}T${DAY_START_HOUR}${TZ_OFFSET}"
  local to="${next_date}T${DAY_START_HOUR}${TZ_OFFSET}"

  echo "Fetching $mode activity ($base_date)..."

  # ãƒ‡ãƒ¼ã‚¿å–å¾—
  local commit_data graphql_data
  commit_data=$(fetch_commits "$from" "$to")
  graphql_data=$(fetch_contributions "$from" "$to")

  # å‡ºåŠ›
  print_report "$from" "$to" "$commit_data" "$graphql_data"
}

main "$@"
